<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="iso-8859-1" />
    <title>Yoyo model viewer!</title>  
    
    <link rel="Stylesheet" href="style.css" type="text/css" />  


    <!-- VERTEX shader -->
    <script id="vertexShader" type="x-shader/x-vertex">
        attribute highp vec3 aVertexPosition;
        attribute highp vec2 aTextureCoord;
        
        uniform highp mat4 uWorldMatrix;
        uniform highp mat4 uMVMatrix;
        uniform highp mat4 uProjMatrix;

        uniform sampler2D uDiffuseSampler;

        varying highp vec4 m_position;
        varying highp vec2 vTextureCoord;
        
        varying highp vec4 m_worldpos;       

        void main(void) 
        {          
            
            m_worldpos = uWorldMatrix * vec4(aVertexPosition, 1.0);

            m_position = uProjMatrix * uMVMatrix * uWorldMatrix * vec4(aVertexPosition, 1.0);

            vTextureCoord = aTextureCoord;

            gl_Position = m_position;
        }
    </script>

    <!-- FRAGMENT/ PIXEL shader -->
    <script id="fragmentShader" type="x-shader/x-fragment">             
        uniform sampler2D uDiffuseSampler;
        uniform sampler2D uNormalSampler;
        //Gets an already normalized lightDir
        uniform highp vec3 uLightDir;

        varying highp vec4 m_position;
        varying highp vec2 vTextureCoord; 
        
        varying highp vec4 m_worldpos;  
        
        uniform highp mat4 uWorldMatrix;    

        void main(void) 
        {
            highp float f_depth = 1.0 - ( m_position.z / m_position.w);
            f_depth *= 3.0; 
            f_depth = 1.0;           

            highp vec4 diffuseColor = texture2D(uDiffuseSampler, vec2(vTextureCoord.s, vTextureCoord.t));
            highp vec3 normalColor = vec3(texture2D(uNormalSampler, vec2(vTextureCoord.s, vTextureCoord.t)));

            //the normal pos in tangentspace, already normalized!
            highp vec3 ts_normal = (normalColor - 0.5) * 2.0;            

            highp vec3 tangent;

            //This ts_normal should be the face normal instead
            highp vec3 c1 = cross(ts_normal, vec3(0.0, 0.0, 1.0)); 
	        highp vec3 c2 = cross(ts_normal, vec3(0.0, 1.0, 0.0));
	        if(length(c1) > length(c2)) 
            {
		        tangent = c1;	
	        }
	        else {
		        tangent = c2;	
	        }	
	        tangent = normalize(tangent);

            highp vec3 binormal;

	        binormal = cross(ts_normal, tangent); 
	        binormal = normalize(binormal);

            highp mat3 rotmat = mat3(tangent,binormal,ts_normal);
            
            highp vec3 ws_normal = normalize(rotmat * ts_normal);          
               
            highp float diffuseBrightness = clamp(dot(ws_normal, uLightDir), 0.0, 1.0);
            
            highp vec3 lightColor = vec3(1, 1, 1);
            
            //Real color!
            gl_FragColor = vec4(f_depth * (lightColor.x * diffuseColor.x * diffuseBrightness),f_depth * (lightColor.y * diffuseColor.y * diffuseBrightness),f_depth * (lightColor.z * diffuseColor.z * diffuseBrightness), 1.0);

            //Worldpos debugging
            //gl_FragColor = vec4(m_worldpos.x + (normalColor.x + diffuseColor.x * 0.001), m_worldpos.y + (normalColor.y + diffuseColor.y * 0.001), m_worldpos.z + (normalColor.x + diffuseColor.x * 0.001), 1.0);

            //Normal diffused color space
            //gl_FragColor = vec4(normalColor.x + (diffuseColor.x * 0.001),normalColor.y + (diffuseColor.y * 0.001), normalColor.z + (diffuseColor.z * 0.001), 1.0);
            //Normal tangent pos
            //gl_FragColor = vec4(ts_normal.x + (diffuseColor.x * 0.001),ts_normal.y + (diffuseColor.y * 0.001), ts_normal.z + (diffuseColor.z * 0.001), 1.0);
            //Normal debugging worldspace
            //gl_FragColor = vec4(ws_normal.x + (diffuseColor.x * 0.001),ws_normal.y + (diffuseColor.y * 0.001), ws_normal.z + (diffuseColor.z * 0.001), 1.0);
            
            //gl_FragColor = vec4(1.0,0,1.0,1.0);
        }
    </script>

</head>
	 
<body>
    <!-- a div that covers whole area so body can register onclick events on whole page -->
    <div id="wholepage" >

        <noscript>This application requires javascript and HTML 5!</noscript>      
    
    
        <canvas id="glcanvas" class="unfocused" width="640" height="480">  
            Your browser doesn't appear to support the HTML5 <code>&lt;canvas&gt;</code> element.  
        </canvas>
    
        <div id="modellist">
            
        </div>
        <div class="instructions">
            <p> WASD to move forwards & backwards and strafe left & right. <br /> Arrow Keys to rotate camera</p>
        </div>
    </div>
  
    <script src="js/Utility/jquery.js" ></script>
    <script src="js/Utility/Underscore.js" ></script>
    <script src="js/Utility/Backbone.js" ></script>
    <script src="js/Utility/glMatrix-9-5-0-min.js" type="text/javascript" ></script>
    <script src="js/Utility/Ajax.js" type="text/javascript" ></script>
    <script src="js/Utility/Minortools.js" type="text/javascript" ></script> 
    <script src="js/Model.js" type="text/javascript" ></script>
    <script src="js/Scene.js" type="text/javascript" ></script>
    <script src="js/Camera.js" type="text/javascript" ></script>  
    <script src="js/Shader.js" type="text/javascript" ></script>
    <script src="js/NormalShader.js" type="text/javascript" ></script>
    <script src="js/ViewerControls.js" type="text/javascript" ></script>
    <script src="js/ModelListItem.js" type="text/javascript" ></script>
    <script src="js/ModelListHandler.js" type="text/javascript" ></script>
    <script src="js/View/ModelListView.js" type="text/javascript" ></script>
    <script src="js/Program.js" type="text/javascript" ></script> 
</body>
</html>